name: Deploy Next.js Frontend

on:
  push:
    branches:
      - main


jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        run: |
          # Check if we have Node.js 18+ and npm
          NODE_VERSION=$(node -v 2>/dev/null | cut -d'v' -f2 | cut -d'.' -f1 || echo "0")
          if [ "$NODE_VERSION" -lt 18 ] || ! command -v npm &> /dev/null; then
            echo "Installing Node.js 20..."
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          node -v
          npm -v

      - name: Install dependencies
        run: |
          npm ci

      - name: Create environment file
        run: |
          cat > .env.local << 'EOF'
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          EOF

      - name: Build application
        run: |
          npm run build

      - name: Copy application files
        run: |
          sudo mkdir -p /opt/nextjs-app
          sudo rsync -av --delete --exclude='node_modules' --exclude='.git' --exclude='.next/cache' \
            $GITHUB_WORKSPACE/ /opt/nextjs-app/

      - name: Install production dependencies
        run: |
          cd /opt/nextjs-app
          sudo npm ci --omit=dev

      - name: Set permissions
        run: |
          sudo chown -R $USER:$USER /opt/nextjs-app
          sudo chmod -R 755 /opt/nextjs-app

      - name: Restart application
        run: |
          sudo systemctl restart nextjs-app
          sudo systemctl restart nginx

      - name: Health check
        run: |
          sleep 5
          curl -f http://98.88.224.117:3000 || exit 1

